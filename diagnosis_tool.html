<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°æ–‡ä»¶åˆ†æè¯Šæ–­å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { background-color: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background-color: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
        button { padding: 12px 24px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; font-size: 14px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-danger { background-color: #dc3545; color: white; }
        .log { background-color: #f8f9fa; padding: 15px; border-left: 4px solid #007bff; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 13px; white-space: pre-wrap; }
        .file-info { background-color: #e9ecef; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; color: #007bff; }
        .json-preview { max-height: 200px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; }
        input[type="file"] { margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ åå°æ–‡ä»¶åˆ†æè¯Šæ–­å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·å°†å¸®åŠ©æ‚¨è¯Šæ–­å’Œæµ‹è¯•åå°æ–‡ä»¶åˆ†æåŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯å¼ ä¸‰æµ‹è¯„æ–‡ä»¶çš„é—®é¢˜ã€‚</p>

        <div class="section">
            <h2>ğŸ“ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>
            <input type="file" id="test-file" accept=".txt" multiple>
            <button class="btn-primary" onclick="diagnoseFile()">å¼€å§‹è¯Šæ–­</button>
            <button class="btn-success" onclick="testWithZhangSan()">ä½¿ç”¨å¼ ä¸‰æ•°æ®æµ‹è¯•</button>
            <button class="btn-warning" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>

        <div class="section">
            <h2>ğŸ“Š è¯Šæ–­ç»Ÿè®¡</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-files">0</div>
                    <div>æ€»æ–‡ä»¶æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="valid-files">0</div>
                    <div>æœ‰æ•ˆæ–‡ä»¶</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="parsed-files">0</div>
                    <div>è§£ææˆåŠŸ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="error-files">0</div>
                    <div>è§£æå¤±è´¥</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“‹ è¯Šæ–­ç»“æœ</h2>
            <div id="diagnosis-results"></div>
        </div>

        <div class="section">
            <h2>ğŸ” è¯¦ç»†æ—¥å¿—</h2>
            <div id="detailed-logs"></div>
        </div>
    </div>

    <script>
        let totalFiles = 0;
        let validFiles = 0;
        let parsedFiles = 0;
        let errorFiles = 0;

        // å¼ ä¸‰çš„æµ‹è¯•æ•°æ®
        const zhangSanTestData = {
            "employeeName": "å¼ ä¸‰",
            "timestamp": "2024-01-15T10:30:00.000Z",
            "report": {
                "timestamp": "2024-01-15T10:35:00.000Z",
                "totalScore": 890,
                "totalQuestions": 200,
                "overallAverage": "4.45",
                "overallLevel": "ä¼˜ç§€",
                "dimensionScores": {
                    "æ•¢ä¸ºæ€§": 4.5,
                    "åŸ¹å…»ä¸‹å±": 4.3,
                    "è¯†äººç”¨äºº": 4.6,
                    "å®¢æˆ·å¯¼å‘": 4.8,
                    "ä¿¡æ¯æœé›†": 4.4,
                    "ç»“æœå¯¼å‘": 4.7,
                    "å›¢é˜Ÿåˆä½œ": 4.2,
                    "è¯´æœèƒ½åŠ›": 4.9,
                    "ç³»ç»Ÿæ€ç»´": 4.1,
                    "å‹åŠ›ç®¡ç†": 4.0
                }
            }
        };

        function log(message, type = 'info') {
            const results = document.getElementById('diagnosis-results');
            const logs = document.getElementById('detailed-logs');
            const timestamp = new Date().toLocaleTimeString();
            
            // æ·»åŠ åˆ°ç»“æœåŒºåŸŸ
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            results.appendChild(div);
            
            // æ·»åŠ åˆ°è¯¦ç»†æ—¥å¿—
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            logDiv.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(logDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            results.scrollTop = results.scrollHeight;
            logs.scrollTop = logs.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStats() {
            document.getElementById('total-files').textContent = totalFiles;
            document.getElementById('valid-files').textContent = validFiles;
            document.getElementById('parsed-files').textContent = parsedFiles;
            document.getElementById('error-files').textContent = errorFiles;
        }

        async function diagnoseFile() {
            const fileInput = document.getElementById('test-file');
            const files = fileInput.files;
            
            if (files.length === 0) {
                log('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œæµ‹è¯•', 'warning');
                return;
            }
            
            log('=== å¼€å§‹æ–‡ä»¶è¯Šæ–­ ===', 'info');
            totalFiles = files.length;
            validFiles = 0;
            parsedFiles = 0;
            errorFiles = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                await diagnoseIndividualFile(file, i + 1);
            }
            
            updateStats();
            log('=== è¯Šæ–­å®Œæˆ ===', 'success');
            generateSummaryReport();
        }

        async function diagnoseIndividualFile(file, index) {
            log(`\n--- è¯Šæ–­æ–‡ä»¶ ${index}: ${file.name} ---`, 'info');
            
            // 1. åŸºæœ¬æ–‡ä»¶ä¿¡æ¯
            const fileInfo = {
                name: file.name,
                type: file.type,
                size: file.size,
                lastModified: new Date(file.lastModified).toLocaleString()
            };
            
            log(`æ–‡ä»¶ä¿¡æ¯: ${JSON.stringify(fileInfo, null, 2)}`, 'info');
            
            // 2. æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆä½¿ç”¨ä¿®å¤åçš„é€»è¾‘ï¼‰
            const hasValidExtension = file.name.toLowerCase().endsWith('.txt');
            const hasValidMimeType = file.type === 'text/plain' || 
                                   file.type === '' || 
                                   file.type.startsWith('text/') || 
                                   file.type === 'application/octet-stream';
            const isFileValid = hasValidExtension; // ä¸»è¦åŸºäºæ‰©å±•å
            
            if (isFileValid) {
                validFiles++;
                log(`âœ… æ–‡ä»¶ç±»å‹éªŒè¯é€šè¿‡`, 'success');
                log(`   - æ‰©å±•åæ£€æŸ¥: ${hasValidExtension ? 'é€šè¿‡' : 'å¤±è´¥'}`, 'info');
                log(`   - MIMEç±»å‹: ${file.type || '(ç©º)'} - ${hasValidMimeType ? 'å…¼å®¹' : 'ä¸å…¼å®¹'}`, 'info');
            } else {
                errorFiles++;
                log(`âŒ æ–‡ä»¶ç±»å‹éªŒè¯å¤±è´¥`, 'error');
                return;
            }
            
            // 3. è¯»å–æ–‡ä»¶å†…å®¹
            try {
                log('æ­£åœ¨è¯»å–æ–‡ä»¶å†…å®¹...', 'info');
                const content = await readFileContent(file);
                log(`æ–‡ä»¶è¯»å–æˆåŠŸï¼Œå†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`, 'success');
                
                // æ˜¾ç¤ºå†…å®¹é¢„è§ˆ
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                log(`å†…å®¹é¢„è§ˆ:\n${preview}`, 'info');
                
                // 4. å†…å®¹æ¸…ç†
                const cleanContent = content.replace(/^\uFEFF/, '').trim();
                if (cleanContent.length !== content.length) {
                    log(`å†…å®¹å·²æ¸…ç†ï¼Œå»é™¤äº† ${content.length - cleanContent.length} ä¸ªç‰¹æ®Šå­—ç¬¦`, 'info');
                }
                
                // 5. JSONæ ¼å¼æ£€æŸ¥
                if (!cleanContent) {
                    throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©º');
                }
                
                if (!cleanContent.startsWith('{') || !cleanContent.endsWith('}')) {
                    throw new Error(`ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚å¼€å¤´: "${cleanContent.substring(0, 10)}", ç»“å°¾: "${cleanContent.substring(cleanContent.length - 10)}"`);
                }
                
                // 6. JSONè§£æ
                log('æ­£åœ¨è§£æJSON...', 'info');
                const data = JSON.parse(cleanContent);
                parsedFiles++;
                log('âœ… JSONè§£ææˆåŠŸ', 'success');
                
                // 7. æ•°æ®ç»“æ„éªŒè¯
                if (data.employeeName && data.report) {
                    log(`âœ… æ•°æ®ç»“æ„éªŒè¯é€šè¿‡`, 'success');
                    log(`   - å‘˜å·¥å§“å: ${data.employeeName}`, 'info');
                    log(`   - æ€»åˆ†: ${data.report.totalScore || 'æœªçŸ¥'}`, 'info');
                    log(`   - å¹³å‡åˆ†: ${data.report.overallAverage || 'æœªçŸ¥'}`, 'info');
                    log(`   - ç­‰çº§: ${data.report.overallLevel || 'æœªçŸ¥'}`, 'info');
                    
                    // æ£€æŸ¥ç»´åº¦æ•°æ®
                    if (data.report.dimensionScores) {
                        const dimensionCount = Object.keys(data.report.dimensionScores).length;
                        log(`   - ç»´åº¦æ•°é‡: ${dimensionCount}`, 'info');
                    }
                    
                    if (data.report.dimensionReports) {
                        const reportCount = Object.keys(data.report.dimensionReports).length;
                        log(`   - ç»´åº¦æŠ¥å‘Šæ•°é‡: ${reportCount}`, 'info');
                    }
                    
                } else {
                    errorFiles++;
                    const missing = [];
                    if (!data.employeeName) missing.push('employeeName');
                    if (!data.report) missing.push('report');
                    log(`âŒ æ•°æ®ç»“æ„éªŒè¯å¤±è´¥ï¼Œç¼ºå°‘å­—æ®µ: ${missing.join(', ')}`, 'error');
                }
                
            } catch (error) {
                errorFiles++;
                log(`âŒ å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: ${error.message}`, 'error');
                
                if (error instanceof SyntaxError) {
                    log('è¿™æ˜¯JSONè¯­æ³•é”™è¯¯ï¼Œå¯èƒ½çš„åŸå› :', 'error');
                    log('1. æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼', 'error');
                    log('2. æ–‡ä»¶åŒ…å«ç‰¹æ®Šå­—ç¬¦æˆ–ç¼–ç é—®é¢˜', 'error');
                    log('3. JSONæ ¼å¼ä¸æ­£ç¡®ï¼ˆç¼ºå°‘æ‹¬å·ã€é€—å·ç­‰ï¼‰', 'error');
                }
            }
        }

        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error(`æ— æ³•è¯»å–æ–‡ä»¶: ${e.target.error}`));
                reader.readAsText(file, 'utf-8');
            });
        }

        async function testWithZhangSan() {
            log('=== ä½¿ç”¨å¼ ä¸‰æµ‹è¯•æ•°æ®è¿›è¡Œæ¨¡æ‹Ÿæµ‹è¯• ===', 'info');
            
            totalFiles = 1;
            validFiles = 0;
            parsedFiles = 0;
            errorFiles = 0;
            
            try {
                // æ¨¡æ‹Ÿæ–‡ä»¶å¯¹è±¡
                const mockFile = {
                    name: 'å¼ ä¸‰_æµ‹è¯„æŠ¥å‘Š.txt',
                    type: 'text/plain',
                    size: JSON.stringify(zhangSanTestData).length
                };
                
                log(`æ¨¡æ‹Ÿæ–‡ä»¶ä¿¡æ¯: ${JSON.stringify(mockFile, null, 2)}`, 'info');
                
                // æ–‡ä»¶ç±»å‹éªŒè¯
                const hasValidExtension = mockFile.name.toLowerCase().endsWith('.txt');
                const isFileValid = hasValidExtension;
                
                if (isFileValid) {
                    validFiles++;
                    log('âœ… æ–‡ä»¶ç±»å‹éªŒè¯é€šè¿‡', 'success');
                } else {
                    errorFiles++;
                    log('âŒ æ–‡ä»¶ç±»å‹éªŒè¯å¤±è´¥', 'error');
                    return;
                }
                
                // JSONå†…å®¹æµ‹è¯•
                const jsonContent = JSON.stringify(zhangSanTestData, null, 2);
                log(`ç”Ÿæˆçš„JSONå†…å®¹é•¿åº¦: ${jsonContent.length} å­—ç¬¦`, 'info');
                
                // JSONè§£ææµ‹è¯•
                const parsedData = JSON.parse(jsonContent);
                parsedFiles++;
                log('âœ… JSONè§£ææˆåŠŸ', 'success');
                
                // æ•°æ®éªŒè¯
                if (parsedData.employeeName && parsedData.report) {
                    log('âœ… æ•°æ®ç»“æ„éªŒè¯é€šè¿‡', 'success');
                    log(`   - å‘˜å·¥å§“å: ${parsedData.employeeName}`, 'info');
                    log(`   - æ€»åˆ†: ${parsedData.report.totalScore}`, 'info');
                    log(`   - å¹³å‡åˆ†: ${parsedData.report.overallAverage}`, 'info');
                    log(`   - ç­‰çº§: ${parsedData.report.overallLevel}`, 'info');
                    
                    const dimensionCount = Object.keys(parsedData.report.dimensionScores || {}).length;
                    log(`   - ç»´åº¦æ•°é‡: ${dimensionCount}`, 'info');
                    
                    // æ˜¾ç¤ºJSONé¢„è§ˆ
                    const preview = document.createElement('div');
                    preview.className = 'json-preview';
                    preview.textContent = jsonContent;
                    
                    const container = document.createElement('div');
                    container.innerHTML = '<h4>JSONæ•°æ®é¢„è§ˆ:</h4>';
                    container.appendChild(preview);
                    
                    document.getElementById('diagnosis-results').appendChild(container);
                    
                } else {
                    errorFiles++;
                    log('âŒ æ•°æ®ç»“æ„éªŒè¯å¤±è´¥', 'error');
                }
                
                updateStats();
                log('=== å¼ ä¸‰æ•°æ®æµ‹è¯•å®Œæˆ ===', 'success');
                generateSummaryReport();
                
            } catch (error) {
                errorFiles++;
                log(`âŒ å¼ ä¸‰æ•°æ®æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStats();
            }
        }

        function generateSummaryReport() {
            log('\n=== è¯Šæ–­æ€»ç»“æŠ¥å‘Š ===', 'info');
            log(`æ€»æ–‡ä»¶æ•°: ${totalFiles}`, 'info');
            log(`æœ‰æ•ˆæ–‡ä»¶: ${validFiles}`, validFiles > 0 ? 'success' : 'warning');
            log(`è§£ææˆåŠŸ: ${parsedFiles}`, parsedFiles > 0 ? 'success' : 'warning');
            log(`è§£æå¤±è´¥: ${errorFiles}`, errorFiles > 0 ? 'error' : 'success');
            
            if (parsedFiles === totalFiles && totalFiles > 0) {
                log('ğŸ‰ æ‰€æœ‰æ–‡ä»¶éƒ½å¤„ç†æˆåŠŸï¼åå°åˆ†æåŠŸèƒ½åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œã€‚', 'success');
            } else if (errorFiles > 0) {
                log('âš ï¸ æœ‰æ–‡ä»¶å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯ã€‚', 'warning');
            }
            
            // æä¾›ä¿®å¤å»ºè®®
            if (errorFiles > 0) {
                log('\n=== ä¿®å¤å»ºè®® ===', 'info');
                log('1. ç¡®ä¿æ–‡ä»¶æ‰©å±•åä¸º .txt', 'info');
                log('2. ç¡®ä¿æ–‡ä»¶å†…å®¹æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼', 'info');
                log('3. ç¡®ä¿JSONåŒ…å« employeeName å’Œ report å­—æ®µ', 'info');
                log('4. æ£€æŸ¥æ–‡ä»¶ç¼–ç æ˜¯å¦ä¸ºUTF-8', 'info');
                log('5. ç¡®ä¿JSONæ ¼å¼æ­£ç¡®ï¼ˆæ‹¬å·ã€é€—å·ã€å¼•å·ç­‰ï¼‰', 'info');
            }
        }

        function clearResults() {
            document.getElementById('diagnosis-results').innerHTML = '';
            document.getElementById('detailed-logs').innerHTML = '';
            totalFiles = 0;
            validFiles = 0;
            parsedFiles = 0;
            errorFiles = 0;
            updateStats();
            log('ç»“æœå·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.addEventListener('load', () => {
            log('ğŸ”§ è¯Šæ–­å·¥å…·å·²åŠ è½½å®Œæˆ', 'success');
            log('è¯·é€‰æ‹©æ–‡ä»¶è¿›è¡Œè¯Šæ–­ï¼Œæˆ–ç‚¹å‡»"ä½¿ç”¨å¼ ä¸‰æ•°æ®æµ‹è¯•"è¿›è¡Œæ¨¡æ‹Ÿæµ‹è¯•', 'info');
            updateStats();
        });
    </script>
</body>
</html>